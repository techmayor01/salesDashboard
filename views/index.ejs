<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <%- include ('partials/head') %>
  <body class="">
    <div class="relative flex flex-col min-h-screen bg-slate-200">
      <%- include ('partials/header') %>
      <div class="flex flex-row">
        <div class="lg:w-[220px] lg:p-4"><%- include ('partials/sidebar') %></div>
        <main
          class=" relative top-16 p-4 overflow-auto lg:w-[calc(100%-220px)] w-full bg-slate-200"
          >

          <!-- User Role & Branch Info -->
          <div class="flex items-center justify-between mb-6 border border-gray-200">
            <div class="text-gray-700 text-sm font-medium">
              Welcome, <span class="text-blue-600 font-semibold capitalize"><%= user.role %></span>
            </div>
            <div class="text-gray-700 text-sm">
              Branch: 
              <span class="text-blue-600 font-semibold capitalize">
                <%= ownerBranch && ownerBranch.branch && ownerBranch.branch.branch_name 
                      ? ownerBranch.branch.branch_name 
                      : 'N/A' %>
              </span>
            </div>
          </div>
          


           <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <a href="#" class="bg-white border border-gray-200 shadow-sm hover:shadow-md rounded-lg p-4 flex flex-col items-center justify-center text-blue-600 transition">
              <i class="fa-solid fa-file-invoice-dollar text-xl mb-2"></i>
              <span class="text-sm">Cash Receivable</span>
            </a>
            <a href="#" class="bg-white border border-gray-200 shadow-sm hover:shadow-md rounded-lg p-4 flex flex-col items-center justify-center text-blue-600 transition">
              <i class="fa-solid fa-boxes-stacked text-xl mb-2"></i>
              <span class="text-sm">Add Product</span>
            </a>
            <a href="#" class="bg-white border border-gray-200 shadow-sm hover:shadow-md rounded-lg p-4 flex flex-col items-center justify-center text-blue-600 transition">
              <i class="fa-solid fa-file-invoice text-xl mb-2"></i>
              <span class="text-sm">Add Invoice</span>
            </a>
            <a href="#" class="bg-white border border-gray-200 shadow-sm hover:shadow-md rounded-lg p-4 flex flex-col items-center justify-center text-blue-600 transition">
              <i class="fa-solid fa-building text-xl mb-2"></i>
              <span class="text-sm">Company Info</span>
            </a>
          </div>

       <!-- Report Dropdown (Visible only for Admin and Owner) -->
        <% if (user.role === 'admin' || user.role === 'owner') { %>
          <div class="mb-3" style="display: flex; justify-content: space-between; align-items: center;">
            <label for="reportSelect" class="text-sm text-gray-700 font-medium">Select Report Period:</label><br>
            <select id="reportSelect" class="border border-gray-300 rounded px-3 py-1 text-sm mt-2 w-half">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        <% } %>

        <!-- Summary Title (Always visible) -->
        <p id="summaryTitle" class="text-sm text-gray-600 mb-3">
          Daily Report
        </p>

        <script>
          // JavaScript to handle dynamic report title based on selection
          const reportSelect = document.getElementById("reportSelect");
          const summaryTitle = document.getElementById("summaryTitle");

          // Function to calculate the number of days in the current month
          function getDaysInCurrentMonth() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth(); // Get current month (0-11)
            const lastDayOfMonth = new Date(year, month + 1, 0); // Get last day of the current month
            return lastDayOfMonth.getDate(); // Return the number of days
          }

          // Get the current number of days in the current month
          const daysInCurrentMonth = getDaysInCurrentMonth();

          // Listen for changes in the report period select
          if (reportSelect) {
            reportSelect.addEventListener("change", function() {
              let selectedPeriod = reportSelect.value;
              let titleText = 'Daily Report';  // Default title for Daily

              // Change the title based on the selected report period
              if (selectedPeriod === 'daily') {
                titleText = 'Daily Report';
              } else if (selectedPeriod === 'weekly') {
                titleText = 'Last 7 Days Report';
              } else if (selectedPeriod === 'monthly') {
                titleText = `Last ${daysInCurrentMonth} Days Report`;
              }

              // Set the summary title text dynamically
              summaryTitle.textContent = titleText;
            });
          }
        </script>




          <!-- Summary Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-[#f44236] text-white p-6 rounded-lg shadow">
              <p class="text-2xl font-bold">₦0</p>
              <span>Total Sales</span>
            </div>
            <div class="bg-[#3e70c9] text-white p-6 rounded-lg shadow">
              <p class="text-2xl font-bold">₦</p>
              <span>Total Cash Sales Amount</span>
            </div>
            <div class="bg-[#f59345] text-white p-6 rounded-lg shadow">
              <p class="text-2xl font-bold">₦</p>
              <span>Total Credit Sales</span>
            </div>
            <div class="bg-[#43b968] text-white p-6 rounded-lg shadow">
              <p class="text-2xl font-bold">₦</p>
              <span>Total Debtors Payment</span>
            </div>
          </div>

          <!-- Totals (icons + details) -->
         

          <% if (user.role === 'owner') { %>
            <div class="flex flex-col lg:flex-row gap-6 mt-6">
              <!-- Total Expenses Card -->
              <div class="bg-white p-4 rounded-lg shadow-lg w-full lg:w-1/3">
                <h2 class="text-md font-semibold text-gray-700 mb-2">Total Expenses</h2>
                <div class="text-xl font-bold text-gray-900">₦<span id="totalExpenses">0</span></div>
              </div>
          
              <!-- Total Suppliers Card -->
              <div class="bg-white p-4 rounded-lg shadow-lg w-full lg:w-1/3">
                <h2 class="text-md font-semibold text-gray-700 mb-2">Total Suppliers</h2>
                <div class="text-xl font-bold text-gray-900"><span id="totalSuppliers"><%= suppliers.length %></span> Suppliers</div>
              </div>
          
              <!-- Total Customers Card -->
              <div class="bg-white p-4 rounded-lg shadow-lg w-full lg:w-1/3">
                <h2 class="text-md font-semibold text-gray-700 mb-2">Total Customers</h2>
                <div class="text-xl font-bold text-gray-900"><span id="totalCustomers"><%= customers.length %></span> Customers</div>
              </div>
            </div>
          <% } %>
          
          

          <!-- DEAD STOCK CHART -->
          <h2 class="text-lg font-semibold text-gray-700 mt-6">Stock Analysis</h2>
          <div  style="display: flex; justify-content: space-between; ">
            <div class="bg-white p-4 rounded-lg shadow-lg " style="width: 60%;">
              <h2 class="text-md font-semibold text-gray-700 mb-2">Dead Stock (1+ Month Unsold)</h2>
              <div class="w-full h-48">
                <canvas id="deadStockChart" class="w-full h-full"></canvas>
              </div>
            </div>
          
            <!-- Stock Value Chart -->
            <div class="bg-white p-4 rounded-lg shadow-lg" style="width: 35%;">
              <h2 class="text-md font-semibold text-gray-700 mb-2">Stock Value per Category</h2>
              <div class="w-full h-48">
                <canvas id="stockValueChart" class="w-full h-full"></canvas>
              </div>
            </div>
          </div>
          

          <script src="js/chart.js"></script>

          <script>
            // Sample data — replace with real backend data using EJS or API
            const deadStockLabels = ['Toothpaste', 'Soda', 'Notebook', 'Battery', 'Mop'];
            const deadStockQuantities = [20, 15, 10, 8, 5];
          
            new Chart(document.getElementById("deadStockChart"), {
              type: 'bar',
              data: {
                labels: deadStockLabels,
                datasets: [{
                  label: 'Quantity in Stock',
                  data: deadStockQuantities,
                  backgroundColor: '#f97316' // orange
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: false },
                  title: {
                    display: true,
                    text: 'Products Unsold in the Last 30 Days'
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Stock Quantity'
                    }
                  },
                  x: {
                    title: {
                      display: true,
                      text: 'Products'
                    }
                  }
                }
              }
            });
          </script>

     

          <script>
            // Example data
            const categoryLabels = ['Food', 'Electronics', 'Drinks', 'Clothing', 'Stationery'];
            const categoryValues = [100000, 80000, 50000, 20000, 10000];
          
            new Chart(document.getElementById("stockValueChart"), {
              type: 'doughnut',
              data: {
                labels: categoryLabels,
                datasets: [{
                  label: 'Stock Value (₦)',
                  data: categoryValues,
                  backgroundColor: [
                    '#3b82f6',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6'
                  ]
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'bottom' },
                  title: {
                    display: true,
                    text: 'Stock Value by Category'
                  }
                }
              }
            });
          </script>


          <!-- Customer and Sales Ranking Charts -->
          <h2 class="text-lg font-semibold text-gray-700 mt-6">Customer and Sales Ranking</h2>
          <p class="text-sm text-gray-600">Top 5 Customers and Products</p>
          

          <div style="display: flex; justify-content: space-between; gap: 2%; ">
            <!-- Customer Ranking Chart -->
            <div class="bg-white p-4 rounded-lg shadow-lg w-full lg:w-1/2">
              <h2 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Customer Rankings</h2>
              <canvas id="customerRankingChart" class="w-full h-64"></canvas>
            </div>
          
            <!-- Sales Ranking Chart -->
            <div class="bg-white p-4 rounded-lg shadow-lg w-full lg:w-1/2">
              <h2 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Product Rankings</h2>
              <canvas id="salesRankingChart" class="w-full h-64"></canvas>
            </div>
          </div>
          <script>
            // Sample Data (replace with real values dynamically if needed)
            const customerLabels = ['John', 'Grace', 'Mike', 'Tolu', 'Anita'];
            const customerPurchases = [50, 45, 30, 25, 10]; // most purchasing
            const customerFrequency = [20, 18, 15, 10, 8];  // most frequent
          
            const productLabels = ['Rice', 'Beans', 'Spaghetti', 'Oil', 'Salt'];
            const topSelling = [300, 280, 240, 150, 120];
            const lowPerforming = [5, 8, 10, 15, 20];
          
            // Customer Chart
            new Chart(document.getElementById("customerRankingChart"), {
              type: 'bar',
              data: {
                labels: customerLabels,
                datasets: [
                  {
                    label: 'Purchase Amount',
                    backgroundColor: '#3b82f6',
                    data: customerPurchases
                  },
                  {
                    label: 'Visit Frequency',
                    backgroundColor: '#f59e0b',
                    data: customerFrequency
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'top' },
                  title: { display: true, text: 'Customer Performance' }
                }
              }
            });
          
            // Sales Chart
            new Chart(document.getElementById("salesRankingChart"), {
              type: 'bar',
              data: {
                labels: productLabels,
                datasets: [
                  {
                    label: 'Top Selling',
                    backgroundColor: '#10b981',
                    data: topSelling
                  },
                  {
                    label: 'Low Performing',
                    backgroundColor: '#ef4444',
                    data: lowPerforming
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'top' },
                  title: { display: true, text: 'Product Sales Ranking' }
                }
              }
            });
          </script>
          
        </main>
      </div>
    </div>
    <%- include ('partials/footer') %>
    

  </body>
</html>
